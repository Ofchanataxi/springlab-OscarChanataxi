name: CD - Deploy to Render

on:
  workflow_run:
    workflows: ["CI - Build and Test"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version variables
        id: version
        run: |
          APP_VERSION="v${{ github.run_number }}"
          BUILD_NUMBER="${{ github.run_number }}"
          COMMIT_HASH="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_HASH:0:7}"
          
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          
          echo "ðŸ“¦ Version: $APP_VERSION"
          echo "ðŸ”¢ Build Number: $BUILD_NUMBER"
          echo "ðŸ”— Commit: $COMMIT_SHORT"

      - name: Get current deployment status
        run: |
          echo "ðŸ“Š Current deployment status:"
          
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys?limit=1")
          
          echo "$RESPONSE" | jq '.[0].deploy | {id, status, createdAt}' || echo "No deploys found"

      - name: Trigger Render Deploy
        id: trigger-deploy
        run: |
          echo "ðŸš€ Triggering deployment to Render..."
          
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}")
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
          
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ne 200 ] && [ "$HTTP_CODE" -ne 201 ]; then
            echo "âŒ Failed to trigger deploy. HTTP Code: $HTTP_CODE"
            exit 1
          fi
          
          echo "âœ… Deploy webhook triggered successfully"

      - name: Wait for deployment to appear in API
        run: |
          echo "â³ Waiting 60 seconds for new deployment to appear..."
          sleep 60

      - name: Monitor deployment status
        id: monitor-deploy
        run: |
          echo "ðŸ” Monitoring deployment status..."
          
          MAX_ATTEMPTS=20
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
          
            # Obtener deploys de Render con la estructura correcta
            RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys?limit=1")
          
            # Extraer el estado del deploy (dentro del objeto "deploy")
            LATEST_STATUS=$(echo "$RESPONSE" | jq -r '.[0].deploy.status // "unknown"')
            LATEST_ID=$(echo "$RESPONSE" | jq -r '.[0].deploy.id // "unknown"')
            CREATED_AT=$(echo "$RESPONSE" | jq -r '.[0].deploy.createdAt // "unknown"')
            COMMIT_MSG=$(echo "$RESPONSE" | jq -r '.[0].deploy.commit.message // "unknown"')
          
            echo "ðŸ”„ Attempt $ATTEMPT/$MAX_ATTEMPTS"
            echo "   Deploy ID: $LATEST_ID"
            echo "   Status: $LATEST_STATUS"
            echo "   Commit: $COMMIT_MSG"
            echo "   Created: $CREATED_AT"
          
            # Verificar estados finales exitosos
            if [ "$LATEST_STATUS" == "live" ]; then
              echo "âœ… Deployment successful!"
              echo "deploy_status=success" >> $GITHUB_OUTPUT
              echo "deploy_id=$LATEST_ID" >> $GITHUB_OUTPUT
              exit 0
            fi
          
            # Verificar estados de fallo
            if [ "$LATEST_STATUS" == "build_failed" ] || \
               [ "$LATEST_STATUS" == "canceled" ] || \
               [ "$LATEST_STATUS" == "deactivated" ]; then
              echo "âŒ Deployment failed with status: $LATEST_STATUS"
              echo "deploy_status=failed" >> $GITHUB_OUTPUT
              echo "deploy_id=$LATEST_ID" >> $GITHUB_OUTPUT
              exit 1
            fi
          
            # Estados en progreso
            if [ "$LATEST_STATUS" == "building" ] || \
               [ "$LATEST_STATUS" == "deploying" ] || \
               [ "$LATEST_STATUS" == "pre_deploy" ] || \
               [ "$LATEST_STATUS" == "created" ]; then
              echo "â³ Still deploying... waiting 30 seconds"
              sleep 30
              continue
            fi
          
            # Estado desconocido
            echo "âš ï¸ Unknown status: $LATEST_STATUS"
            sleep 30
          done
          
          # Timeout
          echo "â° Deployment monitoring timeout"
          echo "deploy_status=timeout" >> $GITHUB_OUTPUT
          exit 1

      - name: Deployment successful summary
        if: steps.monitor-deploy.outputs.deploy_status == 'success'
        run: |
          echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ env.APP_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** ${{ env.BUILD_NUMBER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${COMMIT_SHORT}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy ID:** \`${{ steps.monitor-deploy.outputs.deploy_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ðŸŸ¢ Live" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
        env:
          COMMIT_SHORT: ${{ env.COMMIT_HASH }}

      - name: Deployment failed summary
        if: failure()
        run: |
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ env.APP_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** ${{ env.BUILD_NUMBER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ env.COMMIT_HASH }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy ID:** \`${{ steps.monitor-deploy.outputs.deploy_id || 'N/A' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ðŸ”´ Failed" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Automatic rollback will be triggered**" >> $GITHUB_STEP_SUMMARY