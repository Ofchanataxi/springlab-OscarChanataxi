name: Rollback on Failed Deploy

on:
  workflow_run:
    workflows: ["CD - Deploy to Render"]
    types:
      - completed
    branches:
      - main

jobs:
  rollback:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Notify deployment failure
        run: |
          echo "âš ï¸ Deployment to Render failed!"
          echo "ðŸ”„ Initiating automatic rollback..."

      - name: Get last successful deploy
        id: get-deploy
        run: |
          echo "ðŸ” Searching for last successful deployment..."
          
          # Obtener deploys con la estructura correcta de Render
          DEPLOYS=$(curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys?limit=10")
          
          # Buscar el primer deploy con status "live"
          LAST_SUCCESS=$(echo "$DEPLOYS" | jq -r '[.[] | select(.deploy.status=="live")][0].deploy.id')
          
          if [ "$LAST_SUCCESS" == "null" ] || [ -z "$LAST_SUCCESS" ]; then
            echo "âŒ No previous successful deployment found"
            echo "Cannot perform automatic rollback"
          
            # Mostrar los Ãºltimos deploys para diagnÃ³stico
            echo "ðŸ“‹ Recent deployments:"
            echo "$DEPLOYS" | jq -r '.[] | .deploy | "\(.id) - \(.status) - \(.commit.message)"'
          
            exit 1
          fi
          
          echo "âœ… Found last successful deployment: $LAST_SUCCESS"
          
          # Mostrar informaciÃ³n del deploy al que se harÃ¡ rollback
          DEPLOY_INFO=$(echo "$DEPLOYS" | jq -r "[.[] | select(.deploy.id==\"$LAST_SUCCESS\")][0].deploy")
          echo "ðŸ“‹ Rollback target:"
          echo "$DEPLOY_INFO" | jq '{id, status, commit: .commit.message, createdAt}'
          
          echo "deploy_id=$LAST_SUCCESS" >> $GITHUB_OUTPUT

      - name: Execute rollback
        run: |
          echo "ðŸ”„ Executing rollback to deployment: ${{ steps.get-deploy.outputs.deploy_id }}"
          
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys/${{ steps.get-deploy.outputs.deploy_id }}/rollback")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE/d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "âœ… Rollback initiated successfully"
          else
            echo "âš ï¸ Rollback request completed with status: $HTTP_CODE"
          fi

      - name: Wait and verify rollback
        run: |
          echo "â³ Waiting 60 seconds for rollback to process..."
          sleep 60
          
          echo "ðŸ” Verifying rollback status..."
          DEPLOYS=$(curl -s -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys?limit=1")
          
          CURRENT_STATUS=$(echo "$DEPLOYS" | jq -r '.[0].deploy.status')
          CURRENT_ID=$(echo "$DEPLOYS" | jq -r '.[0].deploy.id')
          
          echo "Current deployment:"
          echo "  ID: $CURRENT_ID"
          echo "  Status: $CURRENT_STATUS"
          
          if [ "$CURRENT_STATUS" == "live" ]; then
            echo "âœ… Service is live after rollback"
          else
            echo "âš ï¸ Service status: $CURRENT_STATUS"
          fi

      - name: Rollback summary
        run: |
          echo "### ðŸ”„ Automatic Rollback Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason:** Deployment failed" >> $GITHUB_STEP_SUMMARY
          echo "- **Rolled back to:** \`${{ steps.get-deploy.outputs.deploy_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Executed by:** GitHub Actions (automatic)" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Service has been restored to last working version" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— Check status: https://dashboard.render.com" >> $GITHUB_STEP_SUMMARY